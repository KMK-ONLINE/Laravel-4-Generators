<?php

use Woodling\Woodling;

class {{className}} extends ControllerTest {

  use Codeception\Specify;

	public function testIndex() {
    $path = URL::action('{{Models}}Controller@index', [], false);

    $this->specify("it renders the view", function() use($path) {
      $response = $this->get($path);
      $this->assertResponseOk();
      $this->assertViewHas('{{models}}');
      $this->assertContains('table', $response->getContent());
    });
	}

	public function testCreate() {
    $path = URL::action('{{Models}}Controller@create', [], false);

    $this->specify("renders the view", function() use($path) {
      $response = $this->get($path);
      $this->assertResponseOk();
      $this->assertViewHas('{{model}}');
      $this->assertContains('form', $response->getContent());
    });
	}

	public function testStore() {
    $path = URL::action('{{Models}}Controller@store', [], false);

    ${{model}}Mock = Mockery::mock('{{Model}}')->makePartial();
    App::instance('{{Model}}', ${{model}}Mock);

    $this->specify("when valid, it persists the {{model}} and redirects", function() use($path, ${{model}}Mock) {
      $id = 1;

      ${{model}}Mock->shouldReceive('save')->once()->andReturn(true);
      ${{model}}Mock->shouldReceive('getAttribute')->with('id')->once()->andReturn($id);

      $response = $this->post($path, []);
		  $this->assertRedirectedToRoute('{{models}}.show', ['{{models}}' => $id]);
    });

    $this->specify("when invalid, it flashes errors and redirects", function() use($path, ${{model}}Mock) {
      ${{model}}Mock->shouldReceive('save')->once()->andReturn(false);
      ${{model}}Mock->shouldReceive('errors')->once()->andReturn([]);

      $response = $this->post($path, []);
      $this->assertRedirectedToRoute('{{models}}.create');
      $this->assertSessionHasErrors();
      $this->assertSessionHas('message');
    });
	}

	public function testShow() {
    ${{model}} = Woodling::saved('{{Model}}');
    $path = URL::action('{{Models}}Controller@show', ['{{models}}' => ${{model}}->id], false);

    $this->specify("renders the view", function() use($path, ${{model}}) {
      $response = $this->get($path);
      $this->assertResponseOk();
      $this->assertViewHas('{{model}}');
      $this->assertContains('table', $response->getContent());
    });
  }

	public function testEdit() {
    ${{model}} = Woodling::saved('{{Model}}');
    $path = URL::action('{{Models}}Controller@edit', ['{{models}}' => ${{model}}->id], false);

    $this->specify("renders the view", function() use(${{model}}, $path) {
      $response = $this->get($path);
      $this->assertResponseOk();
      $this->assertViewHas('{{model}}');
      $this->assertContains('form', $response->getContent());
    });
	}

	public function testUpdate() {
    ${{model}} = Woodling::saved('{{Model}}');
    $path = URL::action('{{Models}}Controller@update', ['{{models}}' => ${{model}}->id], false);

    ${{model}}Mock = Mockery::mock(${{model}})->makePartial();
    ${{model}}Mock->shouldReceive('findOrFail')->andReturn(${{model}}Mock);
    App::instance('{{Model}}', ${{model}}Mock);

    $this->specify("when valid, it persists the {{model}} and redirects", function() use($path, ${{model}}Mock) {
      ${{model}}Mock->shouldReceive('save')->once()->andReturn(true);

      $response = $this->put($path, []);
      $this->assertRedirectedToRoute('{{models}}.show', ['{{models}}' => ${{model}}Mock->id]);
    });

    $this->specify("when invalid, it flashes errors and redirects", function() use($path, ${{model}}Mock) {
      ${{model}}Mock->shouldReceive('save')->once()->andReturn(false);
      ${{model}}Mock->shouldReceive('errors')->once()->andReturn([]);

      $response = $this->put($path, []);
      $this->assertRedirectedToRoute('{{models}}.edit', ['{{models}}' => ${{model}}Mock->id]);
      $this->assertSessionHasErrors();
      $this->assertSessionHas('message');
    });
	}

	public function testDestroy() {
    ${{model}} = Woodling::saved('{{Model}}');
    $path = URL::action('{{Models}}Controller@destroy', ['{{models}}' => ${{model}}->id], false);

    ${{model}}Mock = Mockery::mock(${{model}})->makePartial();
    ${{model}}Mock->shouldReceive('findOrFail')->andReturn(${{model}}Mock);
    App::instance('{{Model}}', ${{model}}Mock);

    $this->specify("calls delete on the {{model}}", function() use($path, ${{model}}Mock) {
      ${{model}}Mock->shouldReceive('delete')->once()->andReturn(true);

      $response = $this->delete($path);
      $this->assertRedirectedToRoute('{{models}}.index');
    });
	}

}
